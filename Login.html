<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sign in</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { --bg:#0f1221; --card:#14182b; --text:#e8ebff; --muted:#b9c0ff; --accent:#7c82ff; }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  /* Fully centered layout */
  body{display:grid;place-items:center;min-height:100dvh}
  .wrap{width:100%;max-width:380px;background:var(--card);padding:22px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.4),inset 0 0 0 1px rgba(255,255,255,.05)}
  h1{margin:0 0 4px;font-size:22px}
  /* ↓ make the inputs narrower + centered */
  input[type="email"],
  input[type="password"]{
    width: clamp(280px, 90%, 300px); /* pick your min/ideal/max */
    display: block;
    margin: 6px 0 0;              /* centers inside .wrap */
  }
  .sub{color:var(--muted);margin:0 0 14px}
  label{font-weight:600;font-size:12px;color:var(--muted)}
  /* Smaller inputs */
  input{width:100%;padding:8px 10px;margin-top:6px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:var(--text)}
  .row{display:flex;gap:10px;margin-top:12px}
  button{flex:1;padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:var(--text);font-weight:700;cursor:pointer}
  /* Make Sign in primary */
  .primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 6px 16px rgba(124,130,255,.35)}
  .msg{font-size:12px;color:var(--muted);margin-top:12px;min-height:1.2em}
</style>
<body>
  <div class="wrap">
    <h1>Time Table Sign-in</h1>
    <p class="sub">Sign in or create an account.</p>

    <label>Email</label>
    <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />

    <label style="margin-top:12px">Password</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />

    <div class="row">
      <!-- Sign in highlighted -->
      <button id="signin" class="primary" type="button">Sign in</button>
      <button id="signup" type="button">Sign up</button>
    </div>

    <div class="msg" id="msg"></div>
  </div>

<script>
/* ===== Replace these ===== */
const SUPABASE_URL      = "https://uvidyiedolvtsissfkel.supabase.co";   // ← replace
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2aWR5aWVkb2x2dHNpc3Nma2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTIxMDgsImV4cCI6MjA3ODI2ODEwOH0.WF0WXdilYUooWm_VdUsrvXHdWPU26kvv9urYKOHHooQ";                      // ← replace
const APP_URL           = "https://worlddude.github.io/Timetable-app/Timetable"; // ← replace
const LOGIN_URL         = "https://worlddude.github.io/Timetable-app/Login"; // <— REPLACE

const sb = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);
const $ = (id) => document.getElementById(id);
const msg = (t) => { $("msg").textContent = t || ""; };

function uiBusy(b){
  $("signin").disabled = b; $("signup").disabled = b;
  $("signin").textContent = b ? "Working…" : "Sign in";
}

/* If already signed in, go to app */
async function goIfSignedIn() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) location.href = APP_URL;
}

/* Supabase will parse #access_token on this page; when it sets session, redirect */
supabase.auth.onAuthStateChange((event) => {
  if (event === "SIGNED_IN") goIfSignedIn();
});

/* First load: handle the case where session already exists */
goIfSignedIn();

/* Helpers */
function getCreds(){
  return {
    email: $("email").value.trim(),
    password: $("password").value
  };
}

/* Nice error mapping */
function humanizeAuthError(error){
  const m = (error?.message || "").toLowerCase();
  if (m.includes("already registered") || m.includes("user already") || error?.status === 409) {
    return "Email already in use.";
  }
  if (m.includes("invalid login") || m.includes("invalid email or password")) {
    return "Invalid email or password.";
  }
  return error?.message || "Something went wrong.";
}

/* Sign up: send confirm link back to THIS login page to finish auth, then bounce to app */
$("signup").onclick = async () => {
  const { email, password } = getCreds();
  if (!email || !password) return msg("Enter email and password.");
  uiBusy(true); msg("Creating account…");
  const { error } = await supabase.auth.signUp({
    email, password,
    options: {
      // IMPORTANT: ensures the email confirmation link returns here (not a 404 root)
      emailRedirectTo: LOGIN_URL
    }
  });
  uiBusy(false);
  if (error) return msg(humanizeAuthError(error));
  msg("Check your email to confirm. After clicking the link, you'll be redirected here and then into the app.");
};

/* Sign in (password) */
$("signin").onclick = async () => {
  const { email, password } = getCreds();
  if (!email || !password) return msg("Enter email and password.");
  uiBusy(true); msg("Signing in…");
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  uiBusy(false);
  if (error) return msg(humanizeAuthError(error));
  msg("Signed in.");
  goIfSignedIn();
};
</script>
</body>
</html>
