<!DOCTYPE html>
<html lang="da-DK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Circular Timetable — Profile</title>
<style>
  :root {
    --bg: #0f1221;
    --card: #14182b;
    --text: #e8ebff;
    --muted: #b9c0ff;
    --accent: #7c82ff;
    --danger: #ef4444;
  }
  body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:0;}
  .container { max-width: 600px; margin: 24px auto; padding: 16px; display: flex; flex-direction: column; gap: 24px; }
  h2 { font-size: 18px; margin-bottom: 12px; }
  .section { background: var(--card); border-radius: 20px; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.06); }
  .item:last-child { border-bottom: none; }
  button { background: var(--accent); color: #fff; border:none; padding: 8px 12px; border-radius: 12px; cursor:pointer; }
  button.danger { background: var(--danger); }
  input[type="email"], input[type="password"], textarea { width: 60%; padding: 6px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color: var(--text);}
  textarea { resize: vertical; width: 100%; }
  .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,.2); border-radius: 24px; transition: 0.3s; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: #fff; border-radius: 50%; transition: 0.3s; }
  input:checked + .slider { background: var(--accent); }
  input:checked + .slider:before { transform: translateX(26px); }
  .go-back { margin-bottom: 16px; background: rgba(255,255,255,.1); color: var(--text); }
</style>
</head>
<body>
  <div class="container">
    <button class="go-back" id="backBtn">← Back to Timetable</button>

    <!-- App Settings -->
    <div class="section">
      <h2>App Settings</h2>

      <div class="item">
        <span>Block Notes</span>
        <label class="switch">
          <input type="checkbox" id="notesToggle">
          <span class="slider"></span>
        </label>
      </div>

      <div class="item">
        <span>Goals Section</span>
        <label class="switch">
          <input type="checkbox" id="goalsToggle">
          <span class="slider"></span>
        </label>
      </div>
      
      <div class="item">
        <span>Colorblind Mode</span>
        <label class="switch">
          <input type="checkbox" id="colorblindToggle">
          <span class="slider"></span>
        </label>
      </div>
      
    </div>

    <!-- Profile Settings -->
    <div class="section">
      <h2>Profile Settings</h2>
      <div class="item">
        <span>Sign Out</span>
        <button id="signOutBtn">Sign Out</button>
      </div>
      <div class="item">
        <span>Change Email</span>
        <input type="email" id="emailInput" placeholder="new@example.com">
        <button id="changeEmailBtn">Update</button>
      </div>
      <div class="item">
        <span>Change Password</span>
        <input type="password" id="passwordInput" placeholder="New Password">
        <button id="changePasswordBtn">Update</button>
      </div>
      <div class="item">
        <span>Delete Account</span>
        <button class="danger" id="deleteBtn">Delete Me</button>
      </div>
    </div>

    <!-- App Developer -->
    <div class="section">
      <h2>App Development</h2>
      <div class="item">
        <span>Feedback</span>
      </div>
      <textarea id="feedbackText" placeholder="Write your feedback here..."></textarea>
      <button id="submitFeedbackBtn">Submit Feedback</button>
      <div class="item">
        <span>Credits</span>
        <span> 2025 Mikkel Skov </span>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase config
  const SUPABASE_URL = "https://uvidyiedolvtsissfkel.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2aWR5aWVkb2x2dHNpc3Nma2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTIxMDgsImV4cCI6MjA3ODI2ODEwOH0.WF0WXdilYUooWm_VdUsrvXHdWPU26kvv9urYKOHHooQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const LOGIN_URL = "https://worlddude.github.io/Timetable-app/Login";

  // Elements
  const notesToggle = document.getElementById("notesToggle");
  const goalsToggle = document.getElementById("goalsToggle");
  const colorToggle = document.getElementById("colorblindToggle");

  // Go back
  document.getElementById("backBtn").onclick = () =>
    location.href = "Timetable.html";

  // Sign out
  document.getElementById("signOutBtn").onclick = async () => {
    await sb.auth.signOut();
    location.href = LOGIN_URL;
  };

  // Change email
  document.getElementById("changeEmailBtn").onclick = async () => {
    const email = document.getElementById("emailInput").value;
    if (!email) return alert("Enter a new email");
    const { error } = await sb.auth.updateUser({ email });
    if (error) alert(error.message);
    else alert("Email updated!");
  };

  // Change password
  document.getElementById("changePasswordBtn").onclick = async () => {
    const password = document.getElementById("passwordInput").value;
    if (!password) return alert("Enter a new password");
    const { error } = await sb.auth.updateUser({ password });
    if (error) alert(error.message);
    else alert("Password updated!");
  };

  // Delete account (⚠️ needs backend later)
  document.getElementById("deleteBtn").onclick = async () => {
    alert("Account deletion needs a secure backend. Not enabled yet.");
  };

  // -----------------------------
  // USER SETTINGS (SYNCED)
  // -----------------------------

  async function initSettings() {
    const { data: userData } = await sb.auth.getUser();
    if (!userData?.user) {
      location.href = LOGIN_URL;
      return;
    }

    const userId = userData.user.id;

    // Ensure settings exist
    const { data: existing } = await sb
      .from("user_settings")
      .select("*")
      .eq("user_id", userId)
      .single();

    if (!existing) {
      await sb.from("user_settings").insert({
        user_id: userId,
        block_notes: true,
        goals_enabled: false,
        colorblind_mode: false
      });
    }

    // Load settings
    const { data: settings } = await sb
      .from("user_settings")
      .select("*")
      .eq("user_id", userId)
      .single();

    notesToggle.checked = settings.block_notes;
    goalsToggle.checked = settings.goals_enabled;
    colorToggle.checked = settings.colorblind_mode;

    // Save changes
    notesToggle.onchange = () =>
      sb.from("user_settings")
        .update({ block_notes: notesToggle.checked })
        .eq("user_id", userId);

    goalsToggle.onchange = () =>
      sb.from("user_settings")
        .update({ goals_enabled: goalsToggle.checked })
        .eq("user_id", userId);

    colorToggle.onchange = () =>
      sb.from("user_settings")
        .update({ colorblind_mode: colorToggle.checked })
        .eq("user_id", userId);
  }

  initSettings();

  // -----------------------------
  // FEEDBACK
  // -----------------------------
  document.getElementById("submitFeedbackBtn").onclick = async () => {
    const feedback = document.getElementById("feedbackText").value.trim();
    if (!feedback) return alert("Write feedback first");

    const { data: userData } = await sb.auth.getUser();

    const { error } = await sb.from("feedback").insert({
      user_id: userData.user.id,
      feedback
    });

    if (error) alert(error.message);
    else {
      alert("Feedback submitted!");
      document.getElementById("feedbackText").value = "";
    }
  };
</script>
